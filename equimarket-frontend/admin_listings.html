<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İlan Yönetimi - EquiMarket Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/toast.css">
    <style>
        :root{--racing-green:#1a3d2e;--gold:#c9a55c;--charcoal:#2a2a2a;--warm-gray:#6b6b6b;--light-gray:#f5f4f0;--white:#fff;--success:#4a7c59;--warning:#f59e0b;--error:#dc2626;--shadow-soft:0 4px 20px rgba(26,61,46,.08)}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--charcoal);color:var(--white)}h1,h2,h3{font-family:'Playfair Display',serif}
        .layout{display:flex;min-height:100vh}.sidebar{background:#1a1a1a;width:260px;padding:24px 16px;position:fixed;top:0;bottom:0;left:0;border-right:1px solid rgba(255,255,255,.1)}
        .sidebar-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;text-decoration:none;color:var(--white);font-size:20px;font-weight:700}
        .logo-badge{background:var(--error);font-size:10px;padding:2px 6px;border-radius:4px;margin-left:8px}
        .nav-section-title{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);padding:0 12px;margin:16px 0 8px}
        .nav-link{display:flex;align-items:center;gap:12px;padding:12px;color:rgba(255,255,255,.6);text-decoration:none;border-radius:8px;margin-bottom:4px;font-size:14px}
        .nav-link:hover{background:rgba(255,255,255,.05);color:var(--white)}.nav-link.active{background:var(--gold);color:var(--charcoal)}
        .nav-link svg{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2}.nav-badge{margin-left:auto;background:var(--error);padding:2px 8px;border-radius:10px;font-size:11px}
        .main{flex:1;margin-left:260px;padding:32px;background:var(--light-gray);min-height:100vh}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.page-header h1{font-size:28px;color:var(--charcoal)}
        .filters{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
        .search-input,.filter-select{padding:12px 16px;border:2px solid var(--light-gray);border-radius:10px;font-size:14px;background:var(--white)}
        .search-input{flex:1;min-width:200px}
        .card{background:var(--white);border-radius:16px;box-shadow:var(--shadow-soft);overflow:hidden}
        .table{width:100%;border-collapse:collapse}.table th,.table td{padding:16px 20px;text-align:left}
        .table th{background:var(--light-gray);font-size:11px;text-transform:uppercase;color:var(--warm-gray)}.table td{border-bottom:1px solid var(--light-gray)}
        .listing-cell{display:flex;align-items:center;gap:12px}.listing-img{width:60px;height:60px;border-radius:10px;background:var(--light-gray);display:flex;align-items:center;justify-content:center}
        .listing-img svg{width:30px;height:30px;fill:none;stroke:var(--warm-gray);stroke-width:1.5}
        .badge{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase}
        .badge-pending{background:rgba(245,158,11,.1);color:var(--warning)}.badge-active{background:rgba(74,124,89,.1);color:var(--success)}
        .badge-rejected{background:rgba(220,38,38,.1);color:var(--error)}.badge-sold{background:rgba(59,130,246,.1);color:#3b82f6}
        .action-btn{width:34px;height:34px;border:none;background:var(--light-gray);border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;margin-right:4px;color:var(--warm-gray)}
        .action-btn:hover{background:var(--racing-green);color:var(--white)}.action-btn.approve:hover{background:var(--success)}.action-btn.reject:hover,.action-btn.danger:hover{background:var(--error)}
        .action-btn svg{width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2}
        .pagination{display:flex;justify-content:space-between;padding:20px;border-top:1px solid var(--light-gray)}.pagination-info{color:var(--warm-gray)}
        .page-btn{padding:8px 14px;border:1px solid var(--light-gray);background:var(--white);border-radius:8px;cursor:pointer;margin-left:4px}
        .page-btn.active{background:var(--racing-green);color:var(--white);border-color:var(--racing-green)}.page-btn:disabled{opacity:.5}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;background:var(--success);color:var(--white)}
        @media(max-width:768px){.sidebar{display:none}.main{margin-left:0}}
        .layout{display:none}
        .access-denied{display:none;min-height:100vh;background:var(--light-gray);justify-content:center;align-items:center;flex-direction:column;gap:24px;font-family:'DM Sans',sans-serif}
        .access-denied.show{display:flex}
        .access-denied svg{width:80px;height:80px;fill:none;stroke:var(--error);stroke-width:1.5}
        .access-denied h2{font-family:'Playfair Display',serif;font-size:28px;color:var(--charcoal)}
        .access-denied p{color:var(--warm-gray);font-size:16px}
        .access-denied a{padding:14px 32px;background:var(--racing-green);color:var(--white);border-radius:10px;text-decoration:none;font-weight:600;font-size:15px}
        .access-denied a:hover{background:#2d5a47}
    </style>
</head>
<body>
    <div class="access-denied" id="accessDenied">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M4.93 4.93l14.14 14.14"/></svg>
        <h2>Erişim Yetkiniz Yok</h2>
        <p>Bu sayfayı görüntüleme yetkiniz bulunmamaktadır.</p>
        <a href="homepage_v2.html">Anasayfaya Dön</a>
    </div>
    <div class="layout">
        <aside class="sidebar">
            <a href="admin.html" class="sidebar-logo">EquiMarket<span class="logo-badge">ADMIN</span></a>
            <div class="nav-section-title">Genel</div>
            <a href="admin.html" class="nav-link"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>Dashboard</a>
            <div class="nav-section-title">Yönetim</div>
            <a href="admin_users.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Kullanıcılar</a>
            <a href="admin_listings.html" class="nav-link active"><svg viewBox="0 0 24 24"><path d="M20.5 6c-.2-1.5-1-2.5-2-3-.5-1.3-1.5-2-3-2-1 0-2 .5-2.5 1.3L11.5 4 9 3 5 5 3 8v5l2.5 2.5H9l4-2.5 3 1c2.2 0 3.5-1.5 3.5-4V6z"/></svg>İlanlar<span class="nav-badge" id="pendingBadge">0</span></a>
            <a href="admin_blog.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Blog</a>
            <div class="nav-section-title">Diğer</div>
            <a href="homepage_v2.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>Siteye Git</a>
        </aside>
        <main class="main">
            <div class="page-header"><div><h1>İlan Yönetimi</h1></div><button class="btn" id="bulkBtn" style="display:none" onclick="bulkApprove()">Seçilenleri Onayla</button></div>
            <div class="filters">
                <input type="text" class="search-input" id="search" placeholder="İlan ara...">
                <select class="filter-select" id="statusFilter"><option value="">Tüm Durumlar</option><option value="pending">Bekleyen</option><option value="active">Aktif</option><option value="rejected">Reddedilen</option><option value="sold">Satılan</option></select>
            </div>
            <div class="card">
                <table class="table"><thead><tr><th><input type="checkbox" id="selectAll" onchange="toggleAll()"></th><th>İlan</th><th>Satıcı</th><th>Fiyat</th><th>Durum</th><th>Tarih</th><th>İşlem</th></tr></thead><tbody id="listingsTable"><tr><td colspan="7" style="text-align:center;padding:40px">Yükleniyor...</td></tr></tbody></table>
                <div class="pagination"><span class="pagination-info" id="pageInfo">0 ilan</span><div id="pageButtons"></div></div>
            </div>
        </main>
    </div>
    <script src="js/api.js"></script>
    <script src="js/admin.service.js"></script>
    <script src="js/toast.js"></script>
    <script>
        let page=1,total=1,selected=[];
        document.addEventListener('DOMContentLoaded', async ()=>{
            if (api.isLoggedIn()) { try { const r=await api.get('/auth/me'); if(r.success&&r.data) api.setUser(r.data); } catch(e){} }
            const u=api.getUser();if(!u||u.role!=='admin'){document.getElementById('accessDenied').classList.add('show');return;}
            document.querySelector('.layout').style.display='flex';
            const p=new URLSearchParams(window.location.search);if(p.get('status'))document.getElementById('statusFilter').value=p.get('status');
            loadListings();loadPendingCount();
            document.getElementById('search').addEventListener('input',debounce(()=>{page=1;loadListings();},300));
            document.getElementById('statusFilter').addEventListener('change',()=>{page=1;loadListings();});
        });
        async function loadPendingCount(){try{const r=await api.get('/admin/listings?status=pending&limit=1');if(r.success)document.getElementById('pendingBadge').textContent=r.total;}catch(e){}}
        async function loadListings(){
            let url='/admin/listings?page='+page+'&limit=15';
            const s=document.getElementById('search').value;if(s)url+='&search='+encodeURIComponent(s);
            const st=document.getElementById('statusFilter').value;if(st)url+='&status='+st;
            try{const r=await api.get(url);if(r.success){total=r.totalPages;renderListings(r.data);renderPages(r.total,r.currentPage,r.totalPages);}}catch(e){console.error(e);}
        }
        function renderListings(list){
            const tb=document.getElementById('listingsTable');
            if(!list.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px">İlan bulunamadı</td></tr>';return;}
            const labels={pending:'Bekliyor',active:'Aktif',rejected:'Reddedildi',sold:'Satıldı'};
            tb.innerHTML=list.map(l=>`<tr><td><input type="checkbox" class="item-check" value="${l._id}" onchange="updateSelected()"></td><td><div class="listing-cell"><div class="listing-img"><svg viewBox="0 0 24 24"><path d="M20.5 6c-.2-1.5-1-2.5-2-3-.5-1.3-1.5-2-3-2-1 0-2 .5-2.5 1.3L11.5 4 9 3 5 5 3 8v5l2.5 2.5H9l4-2.5 3 1c2.2 0 3.5-1.5 3.5-4V6z"/></svg></div><div><strong>${l.name}</strong><br><small style="color:var(--warm-gray)">${l.breed||''} · ${l.location?.city||''}</small></div></div></td><td>${l.seller?.name||'?'}</td><td>₺${(l.price||0).toLocaleString('tr-TR')}</td><td><span class="badge badge-${l.status}">${labels[l.status]||l.status}</span></td><td>${new Date(l.createdAt).toLocaleDateString('tr-TR')}</td><td>${l.status==='pending'?`<button class="action-btn approve" onclick="approve('${l._id}')"><svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg></button><button class="action-btn reject" onclick="reject('${l._id}')"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>`:''}<button class="action-btn" onclick="window.open('horse_detail.html?id=${l._id}')"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button><button class="action-btn danger" onclick="deleteListing('${l._id}','${l.name}')"><svg viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button></td></tr>`).join('');
        }
        function renderPages(t,c,p){
            document.getElementById('pageInfo').textContent=t+' ilan';
            let html='<button class="page-btn" onclick="goPage('+(c-1)+')"'+(c<=1?' disabled':'')+'>←</button>';
            for(let i=1;i<=p;i++)if(i===1||i===p||(i>=c-1&&i<=c+1))html+='<button class="page-btn'+(i===c?' active':'')+'" onclick="goPage('+i+')">'+i+'</button>';
            html+='<button class="page-btn" onclick="goPage('+(c+1)+')"'+(c>=p?' disabled':'')+'>→</button>';
            document.getElementById('pageButtons').innerHTML=html;
        }
        function goPage(p){if(p<1||p>total)return;page=p;loadListings();}
        function toggleAll(){const c=document.getElementById('selectAll').checked;document.querySelectorAll('.item-check').forEach(x=>x.checked=c);updateSelected();}
        function updateSelected(){selected=Array.from(document.querySelectorAll('.item-check:checked')).map(x=>x.value);document.getElementById('bulkBtn').style.display=selected.length?'flex':'none';}
        async function approve(id){const ok=await toast.confirm('Bu ilanı onaylamak istediğinize emin misiniz?',{title:'İlan Onayı',confirmText:'Onayla',cancelText:'İptal'});if(!ok)return;try{await api.put('/admin/listings/'+id,{status:'active'});toast.success('İlan başarıyla onaylandı');loadListings();loadPendingCount();}catch(e){toast.error('İşlem sırasında bir hata oluştu');}}
        async function reject(id){const r=await toast.prompt('Lütfen red sebebini belirtin:',{title:'İlan Reddi',placeholder:'Red sebebi...',confirmText:'Reddet',cancelText:'İptal',required:true});if(!r)return;try{await api.put('/admin/listings/'+id,{status:'rejected',rejectionReason:r});toast.success('İlan reddedildi');loadListings();loadPendingCount();}catch(e){toast.error('İşlem sırasında bir hata oluştu');}}
        async function deleteListing(id,name){const ok=await toast.confirm('"'+name+'" ilanı kalıcı olarak silinecek. Devam etmek istiyor musunuz?',{title:'İlanı Sil',confirmText:'Sil',cancelText:'İptal',type:'danger'});if(!ok)return;try{await api.delete('/admin/listings/'+id);toast.success('İlan silindi');loadListings();}catch(e){toast.error('Silme işlemi başarısız');}}
        async function bulkApprove(){if(!selected.length)return;const ok=await toast.confirm(selected.length+' ilan onaylanacak. Devam etmek istiyor musunuz?',{title:'Toplu Onay',confirmText:'Onayla',cancelText:'İptal'});if(!ok)return;try{await api.post('/admin/listings/bulk-approve',{listingIds:selected});toast.success(selected.length+' ilan onaylandı');selected=[];document.getElementById('selectAll').checked=false;loadListings();loadPendingCount();}catch(e){toast.error('İşlem sırasında bir hata oluştu');}}
        function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
    </script>
</body>
</html>
