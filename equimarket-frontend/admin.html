<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - EquiMarket</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/toast.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--racing-green:#1a3d2e;--gold:#c9a55c;--charcoal:#2a2a2a;--warm-gray:#6b6b6b;--light-gray:#f5f4f0;--white:#fff;--success:#4a7c59;--warning:#f59e0b;--error:#dc2626;--shadow-soft:0 4px 20px rgba(26,61,46,.08)}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--charcoal);color:var(--white)}h1,h2,h3{font-family:'Playfair Display',serif}
        .layout{display:flex;min-height:100vh}.sidebar{background:#1a1a1a;width:260px;padding:24px 16px;position:fixed;top:0;bottom:0;left:0;border-right:1px solid rgba(255,255,255,.1)}
        .sidebar-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;text-decoration:none;color:var(--white);font-size:20px;font-weight:700}
        .logo-badge{background:var(--error);font-size:10px;padding:2px 6px;border-radius:4px;margin-left:8px}
        .nav-section-title{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);padding:0 12px;margin:16px 0 8px}
        .nav-link{display:flex;align-items:center;gap:12px;padding:12px;color:rgba(255,255,255,.6);text-decoration:none;border-radius:8px;margin-bottom:4px;font-size:14px}
        .nav-link:hover{background:rgba(255,255,255,.05);color:var(--white)}.nav-link.active{background:var(--gold);color:var(--charcoal)}
        .nav-link svg{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2}.nav-badge{margin-left:auto;background:var(--error);padding:2px 8px;border-radius:10px;font-size:11px}
        .main{flex:1;margin-left:260px;padding:32px;background:var(--light-gray);min-height:100vh}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}.page-header h1{font-size:28px;color:var(--charcoal)}.page-header p{color:var(--warm-gray)}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}.stat-card{background:var(--white);border-radius:16px;padding:24px;box-shadow:var(--shadow-soft)}
        .stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
        .stat-icon svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2}
        .stat-icon.users{background:rgba(59,130,246,.1);color:#3b82f6}.stat-icon.listings{background:rgba(74,124,89,.1);color:var(--success)}
        .stat-icon.pending{background:rgba(245,158,11,.1);color:var(--warning)}.stat-icon.messages{background:rgba(201,165,92,.1);color:var(--gold)}
        .stat-value{font-size:32px;font-weight:700;color:var(--charcoal);font-family:'Playfair Display',serif}.stat-label{color:var(--warm-gray);font-size:14px}
        .card{background:var(--white);border-radius:16px;box-shadow:var(--shadow-soft);overflow:hidden;margin-bottom:24px}
        .card-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--light-gray)}
        .card-title{font-size:16px;font-weight:600;color:var(--charcoal)}.card-link{font-size:13px;color:var(--racing-green);text-decoration:none}
        .table{width:100%;border-collapse:collapse}.table th,.table td{padding:14px 24px;text-align:left}
        .table th{background:var(--light-gray);font-size:11px;text-transform:uppercase;color:var(--warm-gray)}.table td{border-bottom:1px solid var(--light-gray)}
        .badge{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase}
        .badge-pending{background:rgba(245,158,11,.1);color:var(--warning)}.badge-active{background:rgba(74,124,89,.1);color:var(--success)}
        .action-btn{width:32px;height:32px;border:none;background:var(--light-gray);border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;margin-right:4px}
        .action-btn:hover{background:var(--racing-green);color:var(--white)}.action-btn.approve:hover{background:var(--success)}.action-btn.reject:hover{background:var(--error)}
        .action-btn svg{width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;text-decoration:none;background:var(--racing-green);color:var(--white)}
        @media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.stats-grid{grid-template-columns:1fr 1fr}}
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <a href="admin.html" class="sidebar-logo">EquiMarket<span class="logo-badge">ADMIN</span></a>
            <div class="nav-section-title">Genel</div>
            <a href="admin.html" class="nav-link active"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>Dashboard</a>
            <div class="nav-section-title">Yönetim</div>
            <a href="admin_users.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Kullanıcılar</a>
            <a href="admin_listings.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M20.5 6c-.2-1.5-1-2.5-2-3-.5-1.3-1.5-2-3-2-1 0-2 .5-2.5 1.3L11.5 4 9 3 5 5 3 8v5l2.5 2.5H9l4-2.5 3 1c2.2 0 3.5-1.5 3.5-4V6z"/></svg>İlanlar<span class="nav-badge" id="pendingCount">0</span></a>
            <a href="admin_blog.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Blog</a>
            <div class="nav-section-title">Diğer</div>
            <a href="homepage_v2.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>Siteye Git</a>
            <a href="#" onclick="logout()" class="nav-link"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>Çıkış</a>
        </aside>
        <main class="main">
            <div class="page-header"><div><h1>Dashboard</h1><p>EquiMarket yönetim paneli</p></div><a href="admin_listings.html?status=pending" class="btn">Bekleyen İlanlar</a></div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon users"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div class="stat-value" id="totalUsers">0</div><div class="stat-label">Toplam Kullanıcı</div></div>
                <div class="stat-card"><div class="stat-icon listings"><svg viewBox="0 0 24 24"><path d="M20.5 6c-.2-1.5-1-2.5-2-3-.5-1.3-1.5-2-3-2-1 0-2 .5-2.5 1.3L11.5 4 9 3 5 5 3 8v5l2.5 2.5H9l4-2.5 3 1c2.2 0 3.5-1.5 3.5-4V6z"/></svg></div><div class="stat-value" id="activeListings">0</div><div class="stat-label">Aktif İlan</div></div>
                <div class="stat-card"><div class="stat-icon pending"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div><div class="stat-value" id="pendingListings">0</div><div class="stat-label">Bekleyen İlan</div></div>
                <div class="stat-card"><div class="stat-icon messages"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div><div class="stat-value" id="totalMessages">0</div><div class="stat-label">Toplam Mesaj</div></div>
            </div>
            <div class="charts-row" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
                <div class="card">
                    <div class="card-header"><span class="card-title">Aylık Kayıtlar</span></div>
                    <div style="padding:20px;height:280px"><canvas id="monthlyChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Irklara Göre İlanlar</span></div>
                    <div style="padding:20px;height:280px"><canvas id="breedChart"></canvas></div>
                </div>
            </div>
            <div class="charts-row" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
                <div class="card">
                    <div class="card-header"><span class="card-title">Fiyat Dağılımı</span></div>
                    <div style="padding:20px;height:280px"><canvas id="priceChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Şehirlere Göre İlanlar (Top 10)</span></div>
                    <div style="padding:20px;height:280px"><canvas id="cityChart"></canvas></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">Onay Bekleyen İlanlar</span><a href="admin_listings.html?status=pending" class="card-link">Tümünü Gör →</a></div>
                <table class="table"><thead><tr><th>İlan</th><th>Satıcı</th><th>Fiyat</th><th>Tarih</th><th>İşlem</th></tr></thead><tbody id="pendingTable"><tr><td colspan="5" style="text-align:center;padding:40px;color:var(--warm-gray)">Yükleniyor...</td></tr></tbody></table>
            </div>
        </main>
    </div>
    <script src="js/api.js"></script>
    <script src="js/admin.service.js"></script>
    <script src="js/toast.js"></script>
    <script>
        let charts = {};
        document.addEventListener('DOMContentLoaded', async ()=>{
            // Önce backend'den güncel kullanıcı bilgisini al (MongoDB'de role değişmiş olabilir)
            if (api.isLoggedIn()) {
                try {
                    const meResponse = await api.get('/auth/me');
                    if (meResponse.success && meResponse.data) {
                        api.setUser(meResponse.data);
                    }
                } catch(e) { console.error('Admin auth refresh error:', e); }
            }
            const u=api.getUser();
            if(!u||u.role!=='admin'){toast.error('Erişim yetkiniz yok');setTimeout(()=>window.location.href='homepage_v2.html',1500);return;}
            loadStats();loadPending();loadCharts();
        });
        async function loadStats(){
            try{
                const r=await AdminService.getStats();
                if(r.success){
                    document.getElementById('totalUsers').textContent=r.data.users.total;
                    document.getElementById('activeListings').textContent=r.data.listings.active;
                    document.getElementById('pendingListings').textContent=r.data.listings.pending;
                    document.getElementById('totalMessages').textContent=r.data.messages.messages;
                    document.getElementById('pendingCount').textContent=r.data.listings.pending;
                }
            }catch(e){console.error(e);}
        }
        async function loadPending(){
            try{
                const r=await AdminService.getListings({status:'pending',limit:5});
                if(r.success){
                    const tb=document.getElementById('pendingTable');
                    if(!r.data.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--warm-gray)">Bekleyen ilan yok</td></tr>';return;}
                    tb.innerHTML=r.data.map(l=>`<tr><td><strong>${l.name}</strong><br><small>${l.breed||''}</small></td><td>${l.seller?.name||'?'}</td><td>₺${(l.price||0).toLocaleString('tr-TR')}</td><td>${new Date(l.createdAt).toLocaleDateString('tr-TR')}</td><td><button class="action-btn approve" onclick="approve('${l._id}')"><svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg></button><button class="action-btn reject" onclick="reject('${l._id}')"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button></td></tr>`).join('');
                }
            }catch(e){console.error(e);}
        }
        async function approve(id){const ok=await toast.confirm('Bu ilanı onaylamak istediğinize emin misiniz?',{title:'İlan Onayı',confirmText:'Onayla',cancelText:'İptal'});if(!ok)return;try{await AdminService.approveListing(id);toast.success('İlan onaylandı');loadStats();loadPending();}catch(e){toast.error('İşlem başarısız');}}
        async function reject(id){const r=await toast.prompt('Lütfen red sebebini belirtin:',{title:'İlan Reddi',placeholder:'Red sebebi...',confirmText:'Reddet',cancelText:'İptal',required:true});if(!r)return;try{await AdminService.rejectListing(id,r);toast.success('İlan reddedildi');loadStats();loadPending();}catch(e){toast.error('İşlem başarısız');}}
        function logout(){localStorage.removeItem('equimarket_token');localStorage.removeItem('equimarket_user');window.location.href='homepage_v2.html';}

        async function loadCharts(){
            try{
                const r=await AdminService.getChartData();
                if(r.success){
                    const colors={primary:'rgba(26,61,46,0.8)',gold:'rgba(201,165,92,0.8)',gray:'rgba(107,107,107,0.5)'};
                    const chartColors=['#1a3d2e','#c9a55c','#4a7c59','#2d5a47','#3b82f6','#f59e0b','#dc2626','#8b5cf6','#06b6d4','#84cc16'];

                    // Monthly chart
                    const monthlyCtx=document.getElementById('monthlyChart').getContext('2d');
                    charts.monthly=new Chart(monthlyCtx,{type:'line',data:{labels:r.data.monthlyData.map(d=>d.month),datasets:[{label:'Kullanıcılar',data:r.data.monthlyData.map(d=>d.users),borderColor:colors.primary,backgroundColor:'rgba(26,61,46,0.1)',fill:true,tension:0.4},{label:'İlanlar',data:r.data.monthlyData.map(d=>d.listings),borderColor:colors.gold,backgroundColor:'rgba(201,165,92,0.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});

                    // Breed chart
                    const breedNames={ingiliz:'İngiliz',arap:'Arap',turk:'Türk',diger:'Diğer'};
                    const breedCtx=document.getElementById('breedChart').getContext('2d');
                    charts.breed=new Chart(breedCtx,{type:'doughnut',data:{labels:r.data.listingsByBreed.map(b=>breedNames[b._id]||b._id),datasets:[{data:r.data.listingsByBreed.map(b=>b.count),backgroundColor:chartColors.slice(0,r.data.listingsByBreed.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}});

                    // Price chart
                    const priceCtx=document.getElementById('priceChart').getContext('2d');
                    charts.price=new Chart(priceCtx,{type:'bar',data:{labels:r.data.priceDistribution.map(p=>p.label),datasets:[{label:'İlan Sayısı',data:r.data.priceDistribution.map(p=>p.count),backgroundColor:colors.primary,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

                    // City chart
                    const cityCtx=document.getElementById('cityChart').getContext('2d');
                    charts.city=new Chart(cityCtx,{type:'bar',data:{labels:r.data.listingsByCity.map(c=>c._id||'Belirtilmemiş'),datasets:[{label:'İlan Sayısı',data:r.data.listingsByCity.map(c=>c.count),backgroundColor:chartColors.slice(0,r.data.listingsByCity.length),borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
                }
            }catch(e){console.error('Chart load error:',e);}
        }
    </script>
</body>
</html>
