<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satıcı Profili - EquiMarket</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --racing-green: #1a3d2e;
            --racing-green-light: #2d5a47;
            --gold: #c9a55c;
            --gold-light: #e8d5a8;
            --cream: #faf8f3;
            --charcoal: #2a2a2a;
            --warm-gray: #6b6b6b;
            --light-gray: #f5f4f0;
            --white: #ffffff;
            --success: #4a7c59;
            --warning: #f59e0b;
            --error: #dc2626;
            --info: #3b82f6;
            --shadow-soft: 0 4px 20px rgba(26, 61, 46, 0.08);
            --shadow-medium: 0 8px 40px rgba(26, 61, 46, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--charcoal);
            line-height: 1.6;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 16px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: var(--shadow-soft);
        }

        .header-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--racing-green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: var(--gold);
            stroke-width: 1.5;
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--charcoal);
        }

        .logo-text span {
            color: var(--gold);
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-nav a {
            font-size: 14px;
            color: var(--warm-gray);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .header-nav a:hover {
            color: var(--charcoal);
            background: var(--light-gray);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--racing-green);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--racing-green-light);
        }

        .btn-outline {
            background: transparent;
            color: var(--charcoal);
            border: 1.5px solid #ddd;
        }

        .btn-outline:hover {
            border-color: var(--racing-green);
            color: var(--racing-green);
        }

        .btn-gold {
            background: var(--gold);
            color: var(--charcoal);
        }

        .btn-gold:hover {
            background: #b8944d;
        }

        /* Cover - compact */
        .cover {
            height: 180px;
            background: linear-gradient(135deg, var(--racing-green) 0%, var(--racing-green-light) 50%, #3d7a5c 100%);
            position: relative;
            margin-top: 64px;
        }

        .cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cover-fade {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.3) 0%, transparent 60%);
        }

        /* Page layout */
        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .profile-layout {
            display: grid;
            grid-template-columns: 300px minmax(0, 1fr);
            gap: 24px;
            margin-top: -48px;
            position: relative;
            z-index: 1;
        }

        /* Sidebar card */
        .sidebar-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            height: fit-content;
        }

        .sidebar-top {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid var(--light-gray);
        }

        .avatar {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: var(--racing-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--white);
            margin: 0 auto 16px;
            border: 3px solid var(--white);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .seller-name {
            font-size: 22px;
            color: var(--charcoal);
            margin-bottom: 4px;
        }

        .seller-company {
            font-size: 14px;
            color: var(--warm-gray);
            margin-bottom: 12px;
        }

        .seller-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-verified {
            background: rgba(74, 124, 89, 0.1);
            color: var(--success);
        }

        .badge-premium {
            background: rgba(201, 165, 92, 0.15);
            color: #8a6d2b;
        }

        .seller-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 16px;
        }

        .stars {
            display: flex;
            gap: 2px;
        }

        .stars svg {
            width: 16px;
            height: 16px;
            fill: var(--gold);
        }

        .stars svg.empty {
            fill: #ddd;
        }

        .rating-text {
            font-size: 14px;
            color: var(--warm-gray);
        }

        .rating-text strong {
            color: var(--charcoal);
        }

        .sidebar-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            border-bottom: 1px solid var(--light-gray);
        }

        .stat {
            padding: 16px 8px;
            text-align: center;
        }

        .stat:not(:last-child) {
            border-right: 1px solid var(--light-gray);
        }

        .stat-val {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--charcoal);
        }

        .stat-lbl {
            font-size: 11px;
            color: var(--warm-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-info {
            padding: 20px 24px;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            font-size: 14px;
            color: var(--charcoal);
        }

        .info-row:not(:last-child) {
            border-bottom: 1px solid var(--light-gray);
        }

        .info-label {
            color: var(--warm-gray);
            min-width: 80px;
            flex-shrink: 0;
        }

        .info-value {
            font-weight: 500;
            word-break: break-word;
        }

        .info-value a {
            color: var(--racing-green);
            text-decoration: none;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        .sidebar-actions {
            padding: 0 24px 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .social-row {
            display: flex;
            gap: 8px;
            padding: 0 24px 20px;
        }

        .social-link {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warm-gray);
            text-decoration: none;
            transition: all 0.2s;
        }

        .social-link:hover {
            background: var(--racing-green);
            color: var(--white);
        }

        .social-link svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* Main content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .content-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        /* Bio card */
        .bio-section {
            padding: 24px;
        }

        .bio-title {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--charcoal);
        }

        .bio-text {
            font-size: 15px;
            line-height: 1.7;
            color: var(--charcoal);
        }

        .specialties {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .specialty-tag {
            padding: 6px 14px;
            background: var(--light-gray);
            border-radius: 6px;
            font-size: 13px;
            color: var(--racing-green);
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
        }

        .tab-btn {
            padding: 16px 24px;
            background: none;
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--warm-gray);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab-btn:hover {
            color: var(--charcoal);
        }

        .tab-btn.active {
            color: var(--racing-green);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 16px;
            right: 16px;
            height: 2px;
            background: var(--gold);
            border-radius: 2px 2px 0 0;
        }

        .tab-count {
            background: var(--light-gray);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 6px;
        }

        .tab-btn.active .tab-count {
            background: rgba(201, 165, 92, 0.2);
            color: #8a6d2b;
        }

        .tab-content {
            padding: 24px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Listings grid */
        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .l-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--light-gray);
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .l-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .l-card-img {
            height: 160px;
            background: var(--light-gray);
            overflow: hidden;
            position: relative;
        }

        .l-card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .l-card-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            background: var(--gold);
            color: var(--charcoal);
        }

        .l-card-body {
            padding: 14px;
        }

        .l-card-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .l-card-meta {
            font-size: 13px;
            color: var(--warm-gray);
            margin-bottom: 8px;
        }

        .l-card-price {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--racing-green);
        }

        /* Reviews */
        .review-card {
            padding: 20px 0;
        }

        .review-card:not(:last-child) {
            border-bottom: 1px solid var(--light-gray);
        }

        .review-top {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--warm-gray);
            overflow: hidden;
            flex-shrink: 0;
        }

        .review-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .review-meta {
            flex: 1;
        }

        .review-name {
            font-weight: 600;
            font-size: 14px;
        }

        .review-date {
            font-size: 12px;
            color: var(--warm-gray);
        }

        .review-stars {
            display: flex;
            gap: 2px;
        }

        .review-stars svg {
            width: 14px;
            height: 14px;
            fill: var(--gold);
        }

        .review-stars svg.empty {
            fill: #ddd;
        }

        .review-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--charcoal);
        }

        .review-response {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
        }

        .review-response-label {
            font-weight: 600;
            color: var(--racing-green);
            margin-bottom: 4px;
            font-size: 12px;
        }

        .review-helpful {
            margin-top: 8px;
        }

        .review-helpful button {
            background: none;
            border: 1px solid #e5e5e5;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--warm-gray);
            transition: all 0.2s;
        }

        .review-helpful button:hover {
            border-color: var(--racing-green);
            color: var(--racing-green);
        }

        .review-helpful button.active {
            background: var(--racing-green);
            color: white;
            border-color: var(--racing-green);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--warm-gray);
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--charcoal);
            margin-bottom: 4px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 28px;
            max-width: 460px;
            width: 100%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warm-gray);
        }

        .modal-close:hover {
            background: var(--charcoal);
            color: var(--white);
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 6px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid #e5e5e5;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--gold);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .star-rating {
            display: flex;
            gap: 6px;
            font-size: 28px;
        }

        .star-rating .star {
            color: #ddd;
            cursor: pointer;
            transition: color 0.15s;
            user-select: none;
        }

        .star-rating .star:hover,
        .star-rating .star.active {
            color: var(--gold);
        }

        @media (max-width: 768px) {
            .cover {
                height: 140px;
            }

            .profile-layout {
                grid-template-columns: 1fr;
                margin-top: -36px;
            }

            .sidebar-card {
                order: -1;
            }

            .sidebar-top {
                padding: 20px;
            }

            .avatar {
                width: 72px;
                height: 72px;
                font-size: 26px;
            }

            .seller-name {
                font-size: 20px;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab-btn {
                white-space: nowrap;
                padding: 14px 16px;
            }

            .listings-grid {
                grid-template-columns: 1fr;
            }
        }
    
        .logo-img {
            height: 52px;
            width: auto;
            object-fit: contain;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-container">
            <a href="homepage_v2.html" class="logo">
                <img src="images/logo-horizontal.png" alt="EquiMarket" class="logo-img">
            </a>
            <div class="header-nav">
                <a href="ilanlar.html">İlanlar</a>
                <a href="login_register.html" class="btn btn-primary" id="authBtn">Giriş Yap</a>
            </div>
        </div>
    </header>

    <div class="cover" id="coverSection">
        <div class="cover-fade"></div>
    </div>

    <div class="page">
        <div class="profile-layout">
            <!-- Sidebar -->
            <aside class="sidebar-card">
                <div class="sidebar-top">
                    <div class="avatar" id="profileAvatar"></div>
                    <h1 class="seller-name" id="profileName">Yükleniyor...</h1>
                    <div class="seller-company" id="profileCompany"></div>
                    <div class="seller-badges" id="profileBadges"></div>
                    <div class="seller-rating" id="ratingSection" style="display:none;">
                        <div class="stars" id="ratingStars"></div>
                        <span class="rating-text"><strong id="ratingValue">0.0</strong> <span
                                id="ratingCount">(0)</span></span>
                    </div>
                </div>

                <div class="sidebar-stats">
                    <div class="stat">
                        <div class="stat-val" id="statListings">0</div>
                        <div class="stat-lbl">İlan</div>
                    </div>
                    <div class="stat">
                        <div class="stat-val" id="statSales">0</div>
                        <div class="stat-lbl">Satış</div>
                    </div>
                    <div class="stat">
                        <div class="stat-val" id="statReviews">0</div>
                        <div class="stat-lbl">Yorum</div>
                    </div>
                </div>

                <div class="sidebar-info" id="sidebarInfo">
                    <!-- JS ile doldurulacak -->
                </div>

                <div class="social-row" id="socialLinks" style="display:none;"></div>

                <div class="sidebar-actions" id="sidebarActions">
                    <button class="btn btn-gold" onclick="openContactModal()">İletişime Geç</button>
                    <button class="btn btn-outline" onclick="openReviewModal()" id="reviewActionBtn"
                        style="display:none;">Değerlendirme Yap</button>
                </div>
            </aside>

            <!-- Main -->
            <div class="main-content">
                <!-- Bio + Specialties -->
                <div class="content-card" id="bioCard" style="display:none;">
                    <div class="bio-section">
                        <h2 class="bio-title">Hakkında</h2>
                        <p class="bio-text" id="profileBio"></p>
                        <div class="specialties" id="specialtiesList" style="display:none;"></div>
                    </div>
                </div>

                <!-- Tabs: Listings + Reviews -->
                <div class="content-card">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchTab(event,'listings')">İlanlar <span
                                class="tab-count" id="listingsCount">0</span></button>
                        <button class="tab-btn" onclick="switchTab(event,'reviews')">Değerlendirmeler <span
                                class="tab-count" id="reviewsCount">0</span></button>
                    </div>
                    <div class="tab-content">
                        <div class="tab-panel active" id="listingsPanel">
                            <div class="listings-grid" id="listingsGrid">
                                <div class="empty-state">
                                    <h3>Yükleniyor...</h3>
                                </div>
                            </div>
                        </div>
                        <div class="tab-panel" id="reviewsPanel">
                            <div id="reviewsList">
                                <div class="empty-state">
                                    <h3>Henüz değerlendirme yok</h3>
                                    <p>Bu satıcı henüz değerlendirilmemiş</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header">
                <h3>İletişime Geç</h3><button class="modal-close" onclick="closeContactModal()"><svg
                        viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg></button>
            </div>
            <form id="contactForm" onsubmit="sendMessage(event)">
                <div class="form-group"><label class="form-label">Konu</label><input type="text" class="form-input"
                        id="messageSubject" placeholder="Mesajınızın konusu" required></div>
                <div class="form-group"><label class="form-label">Mesajınız</label><textarea class="form-textarea"
                        id="messageContent" placeholder="Satıcıya iletmek istediğiniz mesaj..." required></textarea>
                </div>
                <button type="submit" class="btn btn-gold" style="width:100%;">Mesaj Gönder</button>
            </form>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Değerlendirme Yap</h3><button class="modal-close" onclick="closeReviewModal()"><svg
                        viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg></button>
            </div>
            <form id="reviewForm" onsubmit="submitReview(event)">
                <div class="form-group">
                    <label class="form-label">Puanınız</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-value="1">&#9733;</span>
                        <span class="star" data-value="2">&#9733;</span>
                        <span class="star" data-value="3">&#9733;</span>
                        <span class="star" data-value="4">&#9733;</span>
                        <span class="star" data-value="5">&#9733;</span>
                    </div>
                    <input type="hidden" id="reviewRating" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Yorumunuz</label>
                    <textarea class="form-textarea" id="reviewComment"
                        placeholder="Bu satıcı hakkındaki deneyiminizi paylaşın..." required minlength="10"
                        maxlength="500"></textarea>
                    <span style="font-size:12px;color:var(--warm-gray);">En az 10, en fazla 500 karakter</span>
                </div>
                <button type="submit" class="btn btn-gold" style="width:100%;">Değerlendirmeyi Gönder</button>
            </form>
        </div>
    </div>

    <link rel="stylesheet" href="css/toast.css">
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/toast.js"></script>
    <script>
        let sellerId = null, sellerData = null, sellerListings = [], sellerReviews = [];
        let selectedRating = 0;

        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            sellerId = urlParams.get('id');

            if (!sellerId || sellerId === 'undefined' || sellerId === 'null') {
                if (api.isLoggedIn()) {
                    try {
                        const meResponse = await api.get('/auth/me');
                        if (meResponse.success && meResponse.data) {
                            api.setUser(meResponse.data);
                            sellerId = meResponse.data._id || meResponse.data.id;
                        }
                    } catch (e) { }
                }
                if (!sellerId || sellerId === 'undefined') {
                    toast.error('Satıcı bulunamadı');
                    setTimeout(() => window.location.href = 'ilanlar.html', 1500);
                    return;
                }
            }

            // Auth durumunu header'da guncelle
            const currentUser = api.getUser();
            if (currentUser) {
                const authBtn = document.getElementById('authBtn');
                if (authBtn) {
                    authBtn.textContent = 'Panel';
                    authBtn.href = 'dashboard.html';
                }
            }

            loadSellerProfile();
            initStarRating();
        });

        function initStarRating() {
            const stars = document.querySelectorAll('#starRating .star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.value);
                    document.getElementById('reviewRating').value = selectedRating;
                    stars.forEach((s, i) => s.classList.toggle('active', i < selectedRating));
                });
                star.addEventListener('mouseenter', () => {
                    const val = parseInt(star.dataset.value);
                    stars.forEach((s, i) => s.style.color = i < val ? 'var(--gold)' : '#ddd');
                });
            });
            document.getElementById('starRating').addEventListener('mouseleave', () => {
                document.querySelectorAll('#starRating .star').forEach((s, i) => {
                    s.style.color = i < selectedRating ? 'var(--gold)' : '#ddd';
                });
            });
        }

        async function loadSellerProfile() {
            try {
                const result = await api.get('/users/seller/' + sellerId);
                if (!result.success) throw new Error(result.message);
                sellerData = result.data;
                renderProfile();
                loadSellerListings();
                loadSellerReviews();
            } catch (e) {
                document.getElementById('profileName').textContent = 'Profil yüklenemedi';
                toast.error('Satıcı profili yüklenirken bir hata oluştu');
            }
        }

        function renderProfile() {
            const s = sellerData;
            document.title = s.name + ' - EquiMarket Satıcı Profili';

            // Cover
            if (s.coverPhoto) {
                const cover = document.getElementById('coverSection');
                cover.innerHTML = '<img src="' + s.coverPhoto + '" style="width:100%;height:100%;object-fit:cover;"><div class="cover-fade"></div>';
            }

            // Avatar
            const av = document.getElementById('profileAvatar');
            const initials = s.name ? s.name.substring(0, 2).toUpperCase() : '?';
            if (s.avatar && s.avatar.startsWith('http')) {
                av.innerHTML = '<img src="' + s.avatar + '" onerror="this.parentElement.textContent=\'' + initials + '\'">';
            } else {
                av.textContent = initials;
            }

            // Name
            document.getElementById('profileName').textContent = s.name;

            // Company
            const companyEl = document.getElementById('profileCompany');
            if (s.sellerInfo?.companyName) companyEl.textContent = s.sellerInfo.companyName;
            else companyEl.style.display = 'none';

            // Badges
            let badges = '';
            if (s.sellerInfo?.isVerifiedSeller) badges += '<span class="badge badge-verified">Dogrulanmis</span>';
            if (s.subscription?.plan === 'premium') badges += '<span class="badge badge-premium">Premium</span>';
            document.getElementById('profileBadges').innerHTML = badges;

            // Rating
            const rating = s.sellerInfo?.rating || 0;
            const totalReviews = s.sellerInfo?.totalReviews || 0;
            if (rating > 0 || totalReviews > 0) {
                document.getElementById('ratingSection').style.display = 'flex';
                document.getElementById('ratingValue').textContent = rating.toFixed(1);
                document.getElementById('ratingCount').textContent = '(' + totalReviews + ')';
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) starsHtml += '<svg viewBox="0 0 24 24"' + (i > Math.round(rating) ? ' class="empty"' : '') + '><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
                document.getElementById('ratingStars').innerHTML = starsHtml;
            }

            // Stats
            document.getElementById('statSales').textContent = s.sellerInfo?.totalSales || 0;
            document.getElementById('statReviews').textContent = totalReviews;
            document.getElementById('reviewsCount').textContent = totalReviews;

            // Sidebar info
            const infoEl = document.getElementById('sidebarInfo');
            let infoHtml = '';
            if (s.location?.city) {
                const loc = (s.location.district ? s.location.district + ', ' : '') + s.location.city;
                infoHtml += '<div class="info-row"><span class="info-label">Konum</span><span class="info-value">' + loc + '</span></div>';
            }
            if (s.createdAt) {
                const memberDate = new Date(s.createdAt).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long' });
                infoHtml += '<div class="info-row"><span class="info-label">Uye</span><span class="info-value">' + memberDate + "\'dan beri</span></div>";
            }
            if (s.sellerInfo?.tjkLicenseNo) {
                infoHtml += '<div class="info-row"><span class="info-label">TJK Lisans</span><span class="info-value">' + s.sellerInfo.tjkLicenseNo + '</span></div>';
            }
            if (s.phone) {
                infoHtml += '<div class="info-row"><span class="info-label">Telefon</span><span class="info-value">' + s.phone + '</span></div>';
            }
            if (s.website) {
                infoHtml += '<div class="info-row"><span class="info-label">Web</span><span class="info-value"><a href="' + s.website + '" target="_blank" rel="noopener">' + s.website.replace(/https?:\/\//, '') + '</a></span></div>';
            }
            if (s.email) {
                infoHtml += '<div class="info-row"><span class="info-label">E-posta</span><span class="info-value"><a href="mailto:' + s.email + '">' + s.email + '</a></span></div>';
            }
            infoEl.innerHTML = infoHtml || '<div class="info-row"><span class="info-value" style="color:var(--warm-gray);">Bilgi girilmemis</span></div>';

            // Social
            let social = '';
            if (s.socialLinks?.instagram) social += '<a href="' + s.socialLinks.instagram + '" target="_blank" rel="noopener" class="social-link"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/></svg></a>';
            if (s.socialLinks?.facebook) social += '<a href="' + s.socialLinks.facebook + '" target="_blank" rel="noopener" class="social-link"><svg viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a>';
            if (s.socialLinks?.twitter) social += '<a href="' + s.socialLinks.twitter + '" target="_blank" rel="noopener" class="social-link"><svg viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5 0-.28-.03-.56-.08-.83A7.72 7.72 0 0023 3z"/></svg></a>';
            if (s.socialLinks?.youtube) social += '<a href="' + s.socialLinks.youtube + '" target="_blank" rel="noopener" class="social-link"><svg viewBox="0 0 24 24"><path d="M22.54 6.42a2.78 2.78 0 00-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78 0 003.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.33z"/><polygon points="9.75,15.02 15.5,11.75 9.75,8.48"/></svg></a>';
            if (social) {
                const socialEl = document.getElementById('socialLinks');
                socialEl.innerHTML = social;
                socialEl.style.display = 'flex';
            }

            // Bio
            if (s.bio) {
                document.getElementById('bioCard').style.display = 'block';
                document.getElementById('profileBio').textContent = s.bio;
            }

            // Specialties
            if (s.sellerInfo?.specialties?.length) {
                if (!s.bio) document.getElementById('bioCard').style.display = 'block';
                const specEl = document.getElementById('specialtiesList');
                specEl.style.display = 'flex';
                specEl.innerHTML = s.sellerInfo.specialties.map(x => '<span class="specialty-tag">' + x + '</span>').join('');
            }

            // Show review button if not own profile
            const currentUser = api.getUser();
            const currentUserId = String(currentUser?._id || currentUser?.id || '');
            if (currentUser && currentUserId !== String(sellerId)) {
                document.getElementById('reviewActionBtn').style.display = 'flex';
            }

            // If own profile, change action buttons
            if (currentUser && currentUserId === String(sellerId)) {
                document.getElementById('sidebarActions').innerHTML = '<a href="settings.html" class="btn btn-outline" style="width:100%;justify-content:center;">Profili Düzenle</a><a href="create_listing.html" class="btn btn-gold" style="width:100%;justify-content:center;">Yeni İlan Oluştur</a>';
            }
        }

        async function loadSellerListings() {
            try {
                const r = await api.get('/horses?seller=' + sellerId + '&status=active');
                if (r.success) {
                    sellerListings = Array.isArray(r.data) ? r.data : (r.data?.horses || []);
                    document.getElementById('statListings').textContent = sellerListings.length;
                    document.getElementById('listingsCount').textContent = sellerListings.length;
                    renderListings();
                }
            } catch (e) { }
        }

        function renderListings() {
            const grid = document.getElementById('listingsGrid');
            if (!sellerListings.length) {
                grid.innerHTML = '<div class="empty-state"><h3>Henuz ilan yok</h3><p>Bu saticinin aktif ilani bulunmuyor</p></div>';
                return;
            }

            const breedNames = { ingiliz: 'Ingiliz', arap: 'Arap', turk: 'Turk', diger: 'Diger' };
            const colorNames = { doru: 'Doru', kir: 'Kir', yagiz: 'Yagiz', al: 'Al', diger: 'Diger' };

            grid.innerHTML = sellerListings.map(l => {
                const img = l.images?.find(i => i.isMain)?.url || l.images?.[0]?.url || '';
                const age = l.age || (l.birthDate ? new Date().getFullYear() - new Date(l.birthDate).getFullYear() : '?');
                const meta = [age + ' Yas', breedNames[l.breed] || l.breed, l.location?.city].filter(Boolean).join(' · ');

                return '<a href="horse_detail.html#id=' + (l._id || l.id) + '" class="l-card">' +
                    '<div class="l-card-img">' +
                    (img ? '<img src="' + img + '" alt="' + l.name + '">' : '') +
                    (l.isFeatured ? '<span class="l-card-badge">One Cikan</span>' : '') +
                    '</div>' +
                    '<div class="l-card-body">' +
                    '<div class="l-card-name">' + l.name + '</div>' +
                    '<div class="l-card-meta">' + meta + '</div>' +
                    '<div class="l-card-price">' + formatPrice(l.price) + '</div>' +
                    '</div>' +
                    '</a>';
            }).join('');
        }

        async function loadSellerReviews() {
            try {
                const result = await api.get('/reviews/seller/' + sellerId);
                if (result.success) {
                    sellerReviews = result.data || [];

                    if (result.stats) {
                        const avg = result.stats.averageRating || 0;
                        const total = result.stats.totalReviews || 0;
                        document.getElementById('ratingValue').textContent = avg.toFixed(1);
                        document.getElementById('ratingCount').textContent = '(' + total + ')';
                        document.getElementById('reviewsCount').textContent = total;
                        document.getElementById('statReviews').textContent = total;

                        if (avg > 0 || total > 0) {
                            document.getElementById('ratingSection').style.display = 'flex';
                            let starsHtml = '';
                            for (let i = 1; i <= 5; i++) starsHtml += '<svg viewBox="0 0 24 24"' + (i > Math.round(avg) ? ' class="empty"' : '') + '><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
                            document.getElementById('ratingStars').innerHTML = starsHtml;
                        }
                    }

                    renderReviews();
                }
            } catch (e) { }
        }

        function renderReviews() {
            const container = document.getElementById('reviewsList');
            const currentUser = api.getUser();

            if (!sellerReviews.length) {
                container.innerHTML = '<div class="empty-state"><h3>Henuz degerlendirme yok</h3><p>Bu satici henuz degerlendirilmemis</p></div>';
                return;
            }

            container.innerHTML = sellerReviews.map(r => {
                const reviewer = r.reviewer || {};
                const initials = reviewer.name ? reviewer.name.substring(0, 2).toUpperCase() : '?';
                const date = new Date(r.createdAt).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' });

                let stars = '';
                for (let i = 1; i <= 5; i++) stars += '<svg viewBox="0 0 24 24"' + (i > r.rating ? ' class="empty"' : '') + '><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';

                const isHelpful = currentUser && r.helpfulBy?.includes(currentUser._id || currentUser.id);

                return '<div class="review-card">' +
                    '<div class="review-top">' +
                    '<div class="review-avatar">' + (reviewer.avatar ? '<img src="' + reviewer.avatar + '">' : initials) + '</div>' +
                    '<div class="review-meta"><div class="review-name">' + (reviewer.name || 'Anonim') + '</div><div class="review-date">' + date + '</div></div>' +
                    '<div class="review-stars">' + stars + '</div>' +
                    '</div>' +
                    '<div class="review-text">' + r.comment + '</div>' +
                    (r.sellerResponse ? '<div class="review-response"><div class="review-response-label">Satici Yaniti</div><div>' + r.sellerResponse.comment + '</div></div>' : '') +
                    '<div class="review-helpful"><button class="' + (isHelpful ? 'active' : '') + '" onclick="markHelpful(\'' + r._id + '\')">Yararli (' + (r.helpfulCount || 0) + ')</button></div>' +
                    '</div>';
            }).join('');
        }

        function switchTab(e, tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            e.target.closest('.tab-btn').classList.add('active');
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(tab + 'Panel').classList.add('active');
        }

        function openContactModal() {
            if (!api.getUser()) { toast.warning('Mesaj gondermek icin giris yapiniz'); setTimeout(() => window.location.href = 'login_register.html', 1500); return; }
            document.getElementById('contactModal').classList.add('active');
        }
        function closeContactModal() { document.getElementById('contactModal').classList.remove('active'); }

        function sendMessage(e) {
            e.preventDefault();
            toast.info('Mesajlasma sayfasina yonlendiriliyorsunuz...');
            setTimeout(() => window.location.href = 'messaging.html?to=' + sellerId, 1000);
        }

        function openReviewModal() {
            if (!api.getUser()) { toast.warning('Degerlendirme icin giris yapiniz'); setTimeout(() => window.location.href = 'login_register.html', 1500); return; }
            document.getElementById('reviewModal').classList.add('active');
        }
        function closeReviewModal() { document.getElementById('reviewModal').classList.remove('active'); }

        async function submitReview(e) {
            e.preventDefault();
            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value.trim();

            if (!rating || rating < 1) { toast.warning('Lutfen bir puan secin'); return; }
            if (comment.length < 10) { toast.warning('Yorum en az 10 karakter olmali'); return; }

            try {
                const result = await api.post('/reviews', { sellerId, rating, comment });
                if (result.success) {
                    toast.success('Degerlendirmeniz kaydedildi');
                    closeReviewModal();
                    loadSellerReviews();
                    document.getElementById('reviewForm').reset();
                    selectedRating = 0;
                    document.querySelectorAll('#starRating .star').forEach(s => s.classList.remove('active'));
                } else {
                    toast.error(result.message || 'Bir hata olustu');
                }
            } catch (error) {
                toast.error('Bir hata olustu');
            }
        }

        async function markHelpful(reviewId) {
            if (!api.getUser()) { toast.warning('Giris yapiniz'); return; }
            try {
                const result = await api.post('/reviews/' + reviewId + '/helpful');
                if (result.success) loadSellerReviews();
            } catch (e) { }
        }

        function formatPrice(n) { return n ? '\u20BA' + new Intl.NumberFormat('tr-TR').format(n) : ''; }
    </script>
</body>

</html>